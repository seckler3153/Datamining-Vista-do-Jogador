<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Banco de Dados - All - Datamining</title>
    <link rel="icon" type="image/png" href="Ícone 11 - Datamine.png">
    <style>
        :root {
            --bg-color: #11806A;
            --sidebar-color: #484848;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            font-family: 'Arial Black', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .control-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            gap: 15px;
            align-items: center;
            border: 3px solid #000;
            z-index: 100;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-modo {
            padding: 8px 15px;
            font-family: 'Arial Black', sans-serif;
            cursor: pointer;
            border: 2px solid #000;
            background: #fff;
            color: #000;
            transition: 0.2s;
        }

        .btn-modo:hover { background: #ddd; }
        .btn-modo.active { background: #11806A; color: white; border-color: white; }
        
        .btn-patch {
            padding: 8px 15px;
            font-family: 'Arial Black', sans-serif;
            cursor: pointer;
            border: 2px solid #fff;
            background: #000;
            color: #fff;
            transition: 0.2s;
            font-weight: bold;
        }
        .btn-patch:hover { background: #333; }

        .separator {
            width: 3px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.5);
            margin: 0 10px;
        }

        .grid-players { display: grid; gap: 15px; justify-content: center; width: 100%; }
        .mode-1 { grid-template-columns: 900px; } 
        .mode-4 { grid-template-columns: repeat(2, 700px); }
        .mode-6 { grid-template-columns: repeat(3, 460px); }
        .mode-8 { grid-template-columns: repeat(4, 340px); }

        .main-container {
            display: flex;
            background-color: #fff;
            border: 5px solid #000;
            box-sizing: border-box;
            margin: 0 auto;
            position: relative;
        }

        .mode-1 .main-container { width: 900px; height: 600px; border-width: 8px; }
        .mode-4 .main-container { width: 700px; height: 450px; border-width: 6px; }
        .mode-6 .main-container { width: 460px; height: 320px; border-width: 5px; }
        .mode-8 .main-container { width: 340px; height: 280px; border-width: 4px; }

        .sidebar {
            background-color: var(--sidebar-color);
            display: flex;
            flex-direction: column;
            padding: 8px;
            border-right: 5px solid #000;
            box-sizing: border-box;
        }

        .stat-item { display: flex; align-items: center; color: white; }
        .icon-box { display: flex; justify-content: center; align-items: center; }
        .icon-box img { width: 90%; height: 90%; object-fit: contain; image-rendering: pixelated; }
        .editable-num { font-weight: 900; outline: none; background: transparent; border: none; color: white; }

        .mode-1 .sidebar { width: 250px; justify-content: space-around; }
        .mode-1 .icon-box { width: 85px; height: 85px; }
        .mode-1 .editable-num { font-size: 50px; width: 100px; }

        .mode-4 .sidebar { width: 180px; justify-content: space-around; }
        .mode-4 .icon-box { width: 72px; height: 72px; }
        .mode-4 .editable-num { font-size: 40px; width: 80px; }

        .mode-6 .sidebar { width: 130px; justify-content: space-around; }
        .mode-6 .icon-box { width: 40px; height: 40px; }
        .mode-6 .editable-num { font-size: 28px; width: 50px; }

        .mode-8 .sidebar { width: 100px; justify-content: space-around; }
        .mode-8 .icon-box { width: 40px; height: 40px; }
        .mode-8 .editable-num { font-size: 22px; width: 40px; }

        .player-name { text-decoration: underline; outline: none; }
        .mode-1 .player-name { font-size: 45px; }
        .mode-4 .player-name { font-size: 32px; }
		.mode-6 .player-name { font-size: 25px; }
		.mode-8 .player-name { font-size: 20px; }

        .grid-frame { border: 5px solid #000; flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .drop-zone { border: 1px solid #000; position: relative; background-color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; }
        .drop-zone img { width: 70%; height: 70%; object-fit: contain; display: none; pointer-events: none; }
        .box-index { position: absolute; top: 2px; left: 5px; font-weight: bold; pointer-events: none; }

        .coop-container { display: flex; background-color: #fff; border: 8px solid #000; width: 1100px; height: 650px; box-sizing: border-box; }
        .coop-container .sidebar { width: 250px; border-right: 8px solid #000; padding: 15px 10px; justify-content: space-evenly; }
        .coop-container .icon-box { width: 90px; height: 90px; }
        .coop-container .editable-num { font-size: 70px; width: auto; flex-grow: 1; }
        .coop-container .grid-frame { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr 1fr; border: 8px solid #000; }
        
        /* Alterado para metade do tamanho (50px -> 25px) */
        .coop-container #player-name { font-size: 50px; text-decoration: underline; outline: none; }
        .coop-container #contador-header { font-size: 80px; font-weight: bold; color: #333; background: #eee; padding: 0 20px; border: 4px solid #000; text-align: center; }
		
		.notepad-container {
			background: #fff;
			width: 90%;
			max-width: 800px;
			height: 80vh;
			border: 5px solid #000;
			display: flex;
			flex-direction: column;
			padding: 15px;
			position: relative;
			cursor: default;
		}

		.notepad-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 4px solid #000;
			padding-bottom: 10px;
			margin-bottom: 10px;
		}
		
		.header-left { font-size: 24px; color: #000; font-family: 'Arial Black'; }
		.header-right { display: flex; gap: 10px; }

		/* Botões do Header */
		.btn-header-notepad { padding: 5px 12px; border: 2px solid #000; cursor: pointer; font-family: 'Arial Black'; color: white; }
		.btn-red { background: #e74c3c; }
		.btn-green { background: #11806A; }

		/* Container das camadas */
		.layers-container { position: relative; flex-grow: 1; border: 2px solid #000; overflow: hidden; }

		.notepad-textarea {
			width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
			border: none; padding: 10px; font-size: 16px; resize: none; box-sizing: border-box; z-index: 1; 
		}
		
		#draw-canvas {
			position: absolute; 
			top: 0; 
			left: 0; 
			z-index: 2; 
			pointer-events: none; 
			/* Adicione as linhas abaixo */
			width: 100% !important;
			height: 100% !important;
			display: block;
		}
		#draw-canvas.active { pointer-events: auto; cursor: crosshair; touch-action: none; }

		/* Container das ferramentas ajustado */
		.paint-toolbar { 
			display: none; background: #f4f4f4; border: 2px solid #000; padding: 10px; 
			margin-top: 5px; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: center;
		}
		.paint-toolbar.visible { display: flex; }

		.tool-group { display: flex; align-items: center; gap: 8px; font-size: 11px; font-family: sans-serif; }
		
		#tool-size { width: 80px; cursor: pointer; }
		
		.action-group {
			display: flex;
			gap: 5px;
		}

		/* Cor de seleção solicitada para os botões ativos */
		.tool-btn.active { 
			background: #11806A !important; 
			color: white !important; 
		}

		/* Estilo do Slider de Espessura */
		#tool-size { width: 100px; cursor: pointer; }
		
		/* Círculo de pré-visualização da ponta */
		.brush-preview-container {
			min-width: 54px; /* Espaço para o tamanho máximo de 100px */
			height: 54px;
			border: 1px solid #ccc;
			background: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-left: 10px;
		}

		#brush-preview {
			border-radius: 50%;
			background-color: #000;
			transition: width 0.1s, height 0.1s;
		}

		/* Botão de cor customizado para parecer profissional */
		#tool-color { width: 40px; height: 30px; border: 1px solid #000; cursor: pointer; padding: 0; }
		.tool-btn { padding: 6px 10px; font-size: 11px; text-transform: uppercase; font-weight: bold; cursor: pointer; border: 1px solid #000; background: #fff; }
		.tool-btn.active { background: #11806A; color: white; }

		.btn-nota {
			background: #777;
			color: #fff;
			border: 2px solid #fff;
			padding: 8px 15px;
			font-family: 'Arial Black', sans-serif;
			cursor: pointer;
			font-weight: bold;
			transition: 0.2s;
		}

		.btn-nota:hover { background: #444; }

        .mobile-counter-controls {
            display: none;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }
        .btn-counter {
            padding: 15px 30px;
            font-family: 'Arial Black', sans-serif;
            font-size: 24px;
            background: #fff;
            border: 4px solid #000;
            cursor: pointer;
            touch-action: manipulation;
        }
        .btn-counter:active { background: #ddd; }

        @media (max-width: 768px) {
            .control-header { padding: 10px; gap: 8px; }
            .btn-modo, .btn-patch { font-size: 10px; padding: 6px 10px; }
            .separator { display: none; }
            
            .mode-1, .mode-4, .mode-6, .mode-8 { 
                grid-template-columns: 1fr !important; 
                width: 100%;
			}
			
			.btn-nota { font-size: 10px; padding: 6px 10px; }
			.notepad-container { width: 90%; height: 60vh; }
			
			.coop-container #player-name { 
				font-size: 25px !important; 
			}

            .main-container, .coop-container { 
                width: 95vw !important; 
                height: auto !important; 
                min-height: 250px;
                flex-direction: row; 
            }
			
			.paint-toolbar {
				padding: 5px;
				gap: 5px;
			}
			
			.brush-preview-container {
				min-width: 45px;
				height: 45px;
				margin-left: 5px;
			}
			
			#btn-toggle-mode {
				display: none !important;
			}

			/* Reduz o tamanho do slider no mobile para economizar espaço */
			#tool-size { width: 60px; }

            .sidebar { width: 25% !important; }
            .editable-num { font-size: 20px !important; width: 100% !important; }
            .icon-box { width: 30px !important; height: 30px !important; }
            .player-name { font-size: 18px !important; }
            .coop-container #contador-header { font-size: 30px !important; }

            /* Mostra os botões abaixo do grid no mobile */
            .mobile-counter-controls.visible { display: flex; }
        }

        .color-menu, .image-selector-menu {
            display: none;
            position: absolute;
            background: white;
            border: 3px solid black;
            z-index: 1000;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.2);
        }

        .color-menu { flex-direction: column; width: 120px; right: 15px; top: 50px; }
        .color-menu button { border: none; padding: 8px; cursor: pointer; font-size: 11px; font-family: 'Arial Black', sans-serif; text-transform: uppercase; text-align: left; background: white; }
        .color-menu button:hover { background: #eee; }

        .image-selector-menu {
            grid-template-columns: repeat(7, 50px);
            grid-template-rows: repeat(8, 50px);
            gap: 2px;
            padding: 5px;
            background: #484848;
        }
        .img-option { width: 50px; height: 50px; border: 1px solid #000; background: #fff; cursor: pointer; object-fit: contain; }
        .img-option:hover { background: #ddd; }

        .btn-cor-toggle { padding: 4px 8px; font-family: 'Arial Black', sans-serif; font-size: 10px; cursor: pointer; border: 2px solid #000; background: #fff; text-transform: uppercase; }
        .hidden { display: none !important; }
        .content { flex-grow: 1; padding: 15px; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; }

        .lightbox {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border: 5px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
		.draggable-card {
			transition: transform 0.2s ease, opacity 0.2s ease;
			cursor: grab;
		}

		.main-container.dragging {
			opacity: 0.4;
			transform: scale(0.95);
			border: 5px dashed #000;
		}

		/* Evita problemas de seleção de texto durante o arraste */
		.grid-players {
			user-select: none;
		}
    </style>
</head>
<body>

<div class="control-header">
    <label>MODO DE JOGO:</label>
    <button id="btn-1" class="btn-modo" onclick="updateLayout('1')">PvP (1 Jogador)</button>
    <button id="btn-4" class="btn-modo active" onclick="updateLayout('4')">PvP (3-4 Jogadores)</button>
    <button id="btn-6" class="btn-modo" onclick="updateLayout('6')">PvP (5-6 Jogadores)</button>
    <button id="btn-8" class="btn-modo" onclick="updateLayout('8')">PvP (7-8 Jogadores)</button>
    <button id="btn-coop" class="btn-modo" onclick="updateLayout('coop')">Coop</button>
    
    <span class="separator"></span>
    <button class="btn-nota" onclick="toggleNotepad()">Notas</button>
	
	<span class="separator"></span>
    <button class="btn-patch" onclick="showLightbox()">Patches & Bugs</button> </div>
</div>

<div id="lightbox" class="lightbox" onclick="this.style.display='none'">
    <img id="lightbox-img" src="" alt="Regras">
</div>

<div id="global-image-selector" class="image-selector-menu"></div>

<div id="coop-view" class="coop-container hidden">
    <div class="sidebar" id="coop-sidebar"></div>
    <div class="content">
        <div class="header">
            <div id="player-name" contenteditable="true">Grupo</div>
            <div id="contador-header">120</div>
        </div>
        <div class="grid-frame" id="coop-grid-frame"></div>
    </div>
</div>

<div id="mobile-controls" class="mobile-counter-controls">
    <button class="btn-counter" onclick="alterarContador(-1)">-1</button>
    <button class="btn-counter" onclick="alterarContador(1)">+1</button>
</div>

<div id="pvp-grid" class="grid-players"></div>

<div id="notepad-lightbox" class="lightbox" onclick="closeNotepad(event)">
    <div class="notepad-container" onclick="event.stopPropagation()">
        <div class="notepad-header">
            <div class="header-left">ANOTAÇÕES</div>
            <div class="header-right">
                <button id="btn-toggle-mode" class="btn-header-notepad btn-green" onclick="toggleDrawMode()">Modo Livre</button>
                <button class="btn-header-notepad btn-red" onclick="clearAllNotes()">Apagar Notas</button>
            </div>
        </div>

        <div id="paint-tools" class="paint-toolbar">
			<div class="tool-group">
				<button class="tool-btn active" onclick="setTool('brush', this)">Pincel</button>
				<button class="tool-btn" onclick="setTool('eraser', this)">Borracha</button>
			</div>

			<div class="tool-group">
				<span>Tam:</span>
				<input type="range" id="tool-size" min="1" max="50" value="10" oninput="syncSize(this.value)">
				<input type="number" id="tool-size-num" min="1" max="50" value="10" 
					   style="width: 45px; border: 1px solid #000; font-family: monospace;" 
					   oninput="syncSize(this.value)">
				
				<div class="brush-preview-container" title="Prévia">
					<div id="brush-preview" style="width: 10px; height: 10px;"></div>
				</div>
			</div>

			<div class="tool-group">
				<span>Cor:</span>
				<input type="color" id="tool-color" value="#000000" oninput="updatePreview()">
				<span id="hex-display" style="font-size: 11px; font-family: monospace; font-weight: bold; margin-left: 5px;">#000000</span>
			</div>
		</div>

        <div class="layers-container">
            <textarea id="notepad-content" class="notepad-textarea" placeholder="Digite suas notas aqui..."></textarea>
            <canvas id="draw-canvas"></canvas>
        </div>
    </div>
</div>

<script>
    const icons = ['V', 'A', 'B', 'Mini Patch', 'Mini Bug', 'Pedaço do Mapa'];
    let valorContador = 120;
    let modoAtual = '4';
    let targetZoneId = null;

    const imgPvP = 'P&B PvP.png';
    const imgCoop = 'P&B Coop.png';

    function showLightbox() {
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        lbImg.src = (modoAtual === 'coop') ? imgCoop : imgPvP;
        lb.style.display = 'flex';
    }

    const imageSelector = document.getElementById('global-image-selector');
	const totalRecursos = 56;
    for (let i = 1; i <= totalRecursos; i++) {
        const img = document.createElement('img');
        img.src = `Recurso (${i}).png`; 
        img.className = 'img-option';
        img.onclick = () => selectImage(img.src);
        imageSelector.appendChild(img);
    }

    function openImageSelector(e, id) {
        e.preventDefault();
        targetZoneId = id;
        imageSelector.style.display = 'grid';
        imageSelector.style.left = `${e.pageX}px`;
        imageSelector.style.top = `${e.pageY}px`;
    }

    function selectImage(src) {
        if (targetZoneId) {
			const imgElement = document.querySelector(`#${targetZoneId} img`);
        
			// Verifica se a imagem atual (src) já é a mesma que está no quadrado
			// Usamos .getAttribute('src') para comparar o caminho relativo ou .includes()
			if (imgElement.style.display === 'block' && imgElement.src.includes(src)) {
				// Se for igual, apaga (comportamento de toggle)
				imgElement.src = '';
				imgElement.style.display = 'none';
			} else {
				// Se for diferente ou vazio, define a nova imagem
				imgElement.src = src;
				imgElement.style.display = 'block';
			}
		}
		imageSelector.style.display = 'none';
	}

    function clearZone(e, id) {
        e.preventDefault();
        const imgElement = document.querySelector(`#${id} img`);
        imgElement.src = '';
        imgElement.style.display = 'none';
    }

    function syncPlayerData(index) {
        const card = document.querySelector(`.pvp-card-${index}`);
        const name = card.querySelector('.player-name').innerText;
        const color = card.querySelector('.player-name').style.color || 'black';
        window.parent.postMessage({ type: 'syncPlayer', index, name, color }, '*');
    }

    function toggleColorMenu(p) {
        const menu = document.getElementById(`menu-cor-${p}`);
        const isVisible = menu.style.display === 'flex';
        document.querySelectorAll('.color-menu, .image-selector-menu').forEach(m => m.style.display = 'none');
        menu.style.display = isVisible ? 'none' : 'flex';
    }

    function mudarCor(p, cor) {
        const card = document.querySelector(`.pvp-card-${p}`);
        card.querySelector('.player-name').style.color = cor;
        document.getElementById(`menu-cor-${p}`).style.display = 'none';
        syncPlayerData(p);
    }

    const coopSidebar = document.getElementById('coop-sidebar');
    coopSidebar.innerHTML = icons.map((icon, i) => `
        <div class="stat-item">
            <div class="icon-box"><img src="Ícone ${i+1} - ${icon}.png" alt="${icon}"></div>
            <div class="editable-num" contenteditable="true">${i === 0 ? 1 : i === 2 ? 5 : 0}</div>
        </div>
    `).join('');

    const coopGridFrame = document.getElementById('coop-grid-frame');
    for(let i=1; i<=6; i++) {
        coopGridFrame.innerHTML += `
            <div class="drop-zone" id="dz-coop-${i}" onclick="openImageSelector(event, 'dz-coop-${i}')" oncontextmenu="clearZone(event, 'dz-coop-${i}')">
                <span class="box-index">${i}</span>
                <img>
            </div>
        `;
    }

    const pvpGrid = document.getElementById('pvp-grid');
    for (let p = 1; p <= 8; p++) {
        const card = document.createElement('div');
        card.className = `main-container pvp-card-${p} draggable-card`;
		card.setAttribute('draggable', 'true');
        card.innerHTML = `
            <div class="sidebar">
                ${icons.map((icon, i) => `
                    <div class="stat-item">
                        <div class="icon-box"><img src="Ícone ${i+1} - ${icon}.png" alt="${icon}"></div>
                        <div class="editable-num" contenteditable="true">${i === 0 ? 1 : i === 2 ? 5 : 0}</div>
                    </div>
                `).join('')}
            </div>
            <div class="content">
                <div class="header">
                    <div class="player-name" contenteditable="true" oninput="syncPlayerData(${p})">Jogador ${p}</div>
                    <button class="btn-cor-toggle" onclick="toggleColorMenu(${p})">Cor</button>
                    <div class="color-menu" id="menu-cor-${p}">
                        <button onclick="mudarCor(${p}, 'black')">Padrão</button>
                        <button onclick="mudarCor(${p}, 'red')">Vermelho</button>
                        <button onclick="mudarCor(${p}, 'orange')">Laranja</button>
                        <button onclick="mudarCor(${p}, 'yellow')">Amarelo</button>
                        <button onclick="mudarCor(${p}, 'green')">Verde</button>
                        <button onclick="mudarCor(${p}, 'cyan')">Ciano</button>
                        <button onclick="mudarCor(${p}, 'darkblue')">Azul</button>
                        <button onclick="mudarCor(${p}, 'purple')">Roxo</button>
                        <button onclick="mudarCor(${p}, 'magenta')">Magenta</button>
                    </div>
                </div>
                <div class="grid-frame">
                    ${[1, 2, 3, 4].map(i => `
                        <div class="drop-zone" id="dz-${p}-${i}" onclick="openImageSelector(event, 'dz-${p}-${i}')" oncontextmenu="clearZone(event, 'dz-${p}-${i}')">
                            <span class="box-index">${i}</span>
                            <img>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        pvpGrid.appendChild(card);
    }

    function updateLayout(mode) {
        modoAtual = mode;
        const pvpContainer = document.getElementById('pvp-grid');
        const coopContainer = document.getElementById('coop-view');
        const mobileCtrls = document.getElementById('mobile-controls');
        document.querySelectorAll('.btn-modo').forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'coop') {
            pvpContainer.classList.add('hidden');
            coopContainer.classList.remove('hidden');
            mobileCtrls.classList.add('visible'); // Mostra botões mobile
            document.getElementById('btn-coop').classList.add('active');
        } else {
            coopContainer.classList.add('hidden');
            pvpContainer.classList.remove('hidden');
            mobileCtrls.classList.remove('visible'); // Esconde botões mobile
            pvpContainer.className = `grid-players mode-${mode}`;
            document.getElementById(`btn-${mode}`).classList.add('active');
            for (let p = 1; p <= 8; p++) {
                const card = document.querySelector(`.pvp-card-${p}`);
                if (card) p > parseInt(mode) ? card.classList.add('hidden') : card.classList.remove('hidden');
            }
        }
    }

    function alterarContador(valor) {
        valorContador += valor;
        document.getElementById('contador-header').innerText = valorContador;
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.drop-zone') && !e.target.closest('.image-selector-menu') && !e.target.closest('.btn-cor-toggle')) {
            imageSelector.style.display = 'none';
            document.querySelectorAll('.color-menu').forEach(m => m.style.display = 'none');
        }
    });

    window.addEventListener('keydown', (e) => {
        // 1. Verifica se o foco está em um campo editável ou no Bloco de Notas
		const isEditing = e.target.getAttribute('contenteditable') === 'true' || 
						 e.target.tagName === 'TEXTAREA' || 
						 e.target.tagName === 'INPUT';

		// Se estiver editando algo, não faz nada (permite o Enter pular linha)
		if (isEditing) return;

		// 2. Só executa os atalhos se estiver no modo COOP e NÃO estiver editando
		if (modoAtual === 'coop') {
			if (e.key === "Enter") { 
				alterarContador(-1); 
				e.preventDefault(); 
			}
			else if (e.code === "Space") { 
				alterarContador(1); 
				e.preventDefault(); 
			}
		}
	});
	
	const container = document.getElementById('pvp-grid');

		container.addEventListener('dragstart', e => {
			const target = e.target.closest('.draggable-card');
			if (target) {
				target.classList.add('dragging');
				// Define um efeito visual no cursor
				e.dataTransfer.effectAllowed = "move";
			}
		});

		container.addEventListener('dragend', e => {
			const target = e.target.closest('.draggable-card');
			if (target) {
				target.classList.remove('dragging');
				// Remove transformações residuais
				document.querySelectorAll('.draggable-card').forEach(c => c.style.transform = '');
			}
		});

		container.addEventListener('dragover', e => {
			e.preventDefault();
			const dragging = document.querySelector('.dragging');
			const target = e.target.closest('.draggable-card');

			if (!dragging || !target || dragging === target) return;

			const bounding = target.getBoundingClientRect();
			const offset = (e.clientY - bounding.top) / (bounding.bottom - bounding.top);
			const offsetHorizontal = (e.clientX - bounding.left) / (bounding.right - bounding.left);

			// Lógica para Grid: decide se insere antes ou depois baseado na posição do mouse
			// Se o mouse estiver na metade de baixo (ou metade da direita), insere após o alvo
			if (offset > 0.5 || offsetHorizontal > 0.5) {
				target.after(dragging);
			} else {
				target.before(dragging);
			}
		});

    document.addEventListener('DOMContentLoaded', () => updateLayout('4'));
	
	function toggleNotepad() {
		const notepad = document.getElementById('notepad-lightbox');
		notepad.style.display = 'flex';
		// Adicione esta linha para redimensionar o canvas ao abrir:
		if(canvas) {
			const container = canvas.parentElement;
			canvas.width = container.offsetWidth;
			canvas.height = container.offsetHeight;
		}
	}

	// Fecha o lightbox se clicar fora da caixa branca
	function closeNotepad(e) {
		document.getElementById('notepad-lightbox').style.display = 'none';
	}

	// Salva o conteúdo automaticamente no LocalStorage
	const notepadTextarea = document.getElementById('notepad-content');

	// Carrega as notas ao iniciar a página
	document.addEventListener('DOMContentLoaded', () => {
		const savedNotes = localStorage.getItem('datamine_notes');
		if (savedNotes) {
			notepadTextarea.value = savedNotes;
		}
		updateLayout('4'); // Mantém sua chamada original
	});

	// Escuta a digitação e salva
	notepadTextarea.addEventListener('input', () => {
		localStorage.setItem('datamine_notes', notepadTextarea.value);
	});
	
	let canvas, ctx;
	let drawing = false;
	let currentTool = 'brush';
	let history = [];
	let redoHistory = [];

	function initCanvas() {
		canvas = document.getElementById('draw-canvas');
		ctx = canvas.getContext('2d', { willReadFrequently: true });
		const container = canvas.parentElement;
		canvas.width = container.clientWidth;
		canvas.height = container.clientHeight;
		saveState();
		updatePreview();
	}
	
	function syncSize(val) {
		// Garante que o valor respeite o min/max de 5 a 50
		let value = parseInt(val);
		if (value < 1) value = 1;
		if (value > 50) value = 50;

		document.getElementById('tool-size').value = value;
		document.getElementById('tool-size-num').value = value;
		updatePreview();
	}
	
	// Atualiza o círculo de pré-visualização
	function updatePreview() {
		const size = document.getElementById('tool-size').value;
		const color = document.getElementById('tool-color').value;
		const preview = document.getElementById('brush-preview');
		const hexDisplay = document.getElementById('hex-display');
		
		if(hexDisplay) hexDisplay.innerText = color.toUpperCase();

		preview.style.width = size + 'px';
		preview.style.height = size + 'px';
		preview.style.backgroundColor = (currentTool === 'eraser') ? 'transparent' : color;
		preview.style.border = (currentTool === 'eraser') ? '1px solid #000' : 'none';
	}

	function toggleDrawMode() {
		const btn = document.getElementById('btn-toggle-mode');
		const tools = document.getElementById('paint-tools');
		const cvs = document.getElementById('draw-canvas');
		
		if (btn.innerText === "Modo Livre") {
			btn.innerText = "Modo Texto";
			tools.classList.add('visible');
			cvs.classList.add('active');
			if(!canvas) initCanvas();
		} else {
			btn.innerText = "Modo Livre";
			tools.classList.remove('visible');
			cvs.classList.remove('active');
		}
	}

	function setTool(tool, element) {
		currentTool = tool;
		document.querySelectorAll('#paint-tools .tool-btn').forEach(b => b.classList.remove('active'));
		if (element) element.classList.add('active');
		updatePreview();
	}

	// Lógica de Desenho
	document.addEventListener('mousedown', startDrawing);
	document.addEventListener('mousemove', draw);
	document.addEventListener('mouseup', stopDrawing);
	// Adicione estes ouvintes de evento
	canvas.addEventListener('touchstart', startDrawing, { passive: false });
	canvas.addEventListener('touchmove', draw, { passive: false });
	canvas.addEventListener('touchend', stopDrawing, { passive: false });

	function startDrawing(e) {
		const cvs = document.getElementById('draw-canvas');
		if (!cvs.classList.contains('active')) return;
		
		// Previne o scroll da página ao desenhar
		if (e.type === 'touchstart') e.preventDefault();

		drawing = true;
		const rect = canvas.getBoundingClientRect();
		const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
		const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

		ctx.beginPath();
		ctx.moveTo(x, y);
	}

	function draw(e) {
		if (!drawing || currentTool === 'bucket') return;
		if (e.type === 'touchmove') e.preventDefault();

		const rect = canvas.getBoundingClientRect();
		const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
		const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

		const size = document.getElementById('tool-size').value;
		const color = document.getElementById('tool-color').value;

		ctx.lineCap = 'round';
		ctx.lineJoin = 'round';
		ctx.lineWidth = size;
		
		if (currentTool === 'brush') {
			ctx.globalAlpha = 1.0;
			ctx.strokeStyle = color;
			ctx.globalCompositeOperation = 'source-over';
		} 
		else if (currentTool === 'eraser') {
			ctx.globalAlpha = 1.0;
			ctx.globalCompositeOperation = 'destination-out';
		}

		ctx.lineTo(x, y);
		ctx.stroke();
	}
	
	// Lógica do Balde de Tinta (Flood Fill)
	function floodFill(startX, startY, fillColor) {
		const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
		const targetColor = hexToRgb(fillColor);
		const pixelData = imageData.data;

		const startPos = (startY * canvas.width + startX) * 4;
		const startColor = {
			r: pixelData[startPos],
			g: pixelData[startPos + 1],
			b: pixelData[startPos + 2],
			a: pixelData[startPos + 3]
		};

		if (Math.abs(startColor.r - targetColor.r) < 5 && 
			Math.abs(startColor.g - targetColor.g) < 5 && 
			Math.abs(startColor.b - targetColor.b) < 5 &&
			startColor.a === 255) return;

		const stack = [[startX, startY]];
		while (stack.length) {
			const [x, y] = stack.pop();
			const pos = (y * canvas.width + x) * 4;

			if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height &&
				pixelData[pos] === startColor.r && 
				pixelData[pos+1] === startColor.g && 
				pixelData[pos+2] === startColor.b && 
				pixelData[pos+3] === startColor.a) {

				pixelData[pos] = targetColor.r;
				pixelData[pos+1] = targetColor.g;
				pixelData[pos+2] = targetColor.b;
				pixelData[pos+3] = 255;

				stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
			}
		}
		ctx.putImageData(imageData, 0, 0);
		saveState();
	}

	function matchColor(r, g, b, a, target) {
		// Se target vier de hexToRgb ele tem r,g,b. Se vier de pixelData, comparamos com startRGBA
		if(target.a !== undefined) {
			return r === target.r && g === target.g && b === target.b && a === target.a;
		}
		return r === target.r && g === target.g && b === target.b;
		
		const tolerance = 10;
		return Math.abs(r - target.r) <= tolerance && 
			   Math.abs(g - target.g) <= tolerance && 
			   Math.abs(b - target.b) <= tolerance && 
			   Math.abs(a - target.a) <= tolerance;
	}

	function hexToRgb(hex) {
		const r = parseInt(hex.slice(1, 3), 16);
		const g = parseInt(hex.slice(3, 5), 16);
		const b = parseInt(hex.slice(5, 7), 16);
		return { r, g, b, a: 255 };
	}

	// Evento de clique para o Balde
	canvas.addEventListener('mousedown', (e) => {
		if (currentTool === 'bucket') {
			floodFill(e.offsetX, e.offsetY, document.getElementById('tool-color').value);
		} else {
			drawing = true;
			ctx.beginPath();
			ctx.moveTo(e.offsetX, e.offsetY);
		}
	});

	function stopDrawing() {
		if (drawing) {
			drawing = false;
			saveState();
		}
	}

	function fillCanvas() {
		ctx.globalCompositeOperation = 'source-over';
		ctx.fillStyle = document.getElementById('tool-color').value;
		ctx.globalAlpha = document.getElementById('tool-opacity').value;
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		saveState();
	}

	function saveState() {
		history.push(canvas.toDataURL());
		if (history.length > 20) history.shift();
		redoHistory = [];
	}

	function undo() {
		if (history.length > 1) {
			redoHistory.push(history.pop());
			let img = new Image();
			img.src = history[history.length - 1];
			img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
		}
	}

	function redo() {
		if (redoHistory.length > 0) {
			let state = redoHistory.pop();
			history.push(state);
			let img = new Image();
			img.src = state;
			img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); };
		}
	}

	function clearAllNotes() {
		if (confirm("Tem certeza que deseja apagar TODAS as notas e desenhos?")) {
			document.getElementById('notepad-content').value = "";
			if(canvas) ctx.clearRect(0, 0, canvas.width, canvas.height);
			localStorage.removeItem('datamine_notes');
			saveState();
		}
	}
</script>
</body>
</html>